# syntax=docker/dockerfile:1.7
FROM node:22-bookworm-slim

WORKDIR /usr/src/app
ENV NODE_ENV=development
# (opcional) mais heap em projetos grandes
ENV NODE_OPTIONS="--max-old-space-size=4096"

# Use a versão do Yarn/pnpm definida no projeto, via Corepack
RUN corepack enable

# Toolchain mínima para dependências nativas (node-gyp)
RUN apt-get update && apt-get install -y --no-install-recommends \
      ca-certificates python3 make g++ \
    && rm -rf /var/lib/apt/lists/*

# ✅ yalc global + watcher simples (chokidar-cli) para automatizar push
RUN npm i -g yalc chokidar-cli nodemon

# Copiamos manifestos e configs do Nest para o caso de rodar sem bind mount
COPY package.json yarn.lock ./
COPY nest-cli.json tsconfig*.json ./
RUN mkdir -p /usr/src/app/certs

# Instala deps no start (se faltar) e inicia Nest em modo watch
CMD ["/bin/sh","-lc","[ -x node_modules/.bin/nest ] || yarn install --frozen-lockfile; npx -y @nestjs/cli start --watch --debug 0.0.0.0:9229"]
