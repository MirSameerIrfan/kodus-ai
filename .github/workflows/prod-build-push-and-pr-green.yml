name: PROD (GitOps) - Build/Push images + Deploy (Step 1/3)

on:
    release:
        types: [published]
    workflow_dispatch:
        inputs:
            image_tag:
                description: "ECR image tag (default: release tag)"
                required: false

concurrency:
    group: prod-gitops-deploy
    cancel-in-progress: false

permissions:
    contents: read

env:
    AWS_REGION: ${{ secrets.AWS_REGION }}
    IMAGE_TAG: ${{ github.event.inputs.image_tag || github.event.release.tag_name || github.ref_name }}
    BUILDX_PLATFORMS: linux/arm64
    BUILDX_CACHE_SCOPE: kodus-ai-arm64

    # ECR repositories (required)
    ECR_REPOSITORY_API: ${{ vars.ECR_REPOSITORY_API }}
    ECR_REPOSITORY_WEBHOOKS: ${{ vars.ECR_REPOSITORY_WEBHOOKS }}
    ECR_REPOSITORY_WORKER: ${{ vars.ECR_REPOSITORY_WORKER }}

    # GitOps (required)
    INFRA_REPO: ${{ vars.INFRA_REPO }}
    INFRA_BASE_BRANCH: ${{ vars.INFRA_BASE_BRANCH }}
    INFRA_TFVARS_PATH: ${{ vars.INFRA_TFVARS_PATH }}

jobs:
    build_push_and_deploy:
        runs-on: ubuntu-latest
        environment: production
        if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/')
        permissions:
            contents: read
            id-token: write

        steps:
            - name: Validate tag format (x.y.z)
              run: |
                  set -euo pipefail
                  TAG="${{ env.IMAGE_TAG }}"
                  if ! echo "$TAG" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
                    echo "Invalid PROD tag format (expected x.y.z): $TAG"
                    exit 1
                  fi

            - name: Validate required secrets
              run: |
                  set -euo pipefail
                  if [ -z "${{ vars.INFRA_GITHUB_APP_ID }}" ]; then
                    echo "Missing variable: INFRA_GITHUB_APP_ID"
                    exit 1
                  fi
                  for v in ECR_REPOSITORY_API ECR_REPOSITORY_WEBHOOKS ECR_REPOSITORY_WORKER INFRA_REPO INFRA_BASE_BRANCH INFRA_TFVARS_PATH; do
                    if [ -z "${!v:-}" ]; then
                      echo "Missing required variable: $v"
                      exit 1
                    fi
                  done
                  if [ -z "${{ secrets.INFRA_GITHUB_APP_PRIVATE_KEY }}" ]; then
                    echo "Missing secret: INFRA_GITHUB_APP_PRIVATE_KEY"
                    exit 1
                  fi
                  if [ -z "${{ secrets.AWS_REGION }}" ]; then
                    echo "Missing secret: AWS_REGION"
                    exit 1
                  fi
                  if [ -z "${{ secrets.AWS_ROLE_TO_ASSUME }}" ]; then
                    echo "Missing secret: AWS_ROLE_TO_ASSUME (OIDC is required for PROD)"
                    exit 1
                  fi

            - name: Parse infra repo
              run: |
                  set -euo pipefail
                  repo="${{ env.INFRA_REPO }}"
                  if [[ "$repo" == */* ]]; then
                    owner="${repo%%/*}"
                    name="${repo#*/}"
                  else
                    owner="${{ github.repository_owner }}"
                    name="$repo"
                  fi
                  echo "INFRA_REPO_OWNER=$owner" >> "$GITHUB_ENV"
                  echo "INFRA_REPO_NAME=$name" >> "$GITHUB_ENV"

            - name: Get infra repo token (GitHub App)
              id: infra_token
              uses: actions/create-github-app-token@v1.11.0
              with:
                  app-id: ${{ vars.INFRA_GITHUB_APP_ID }}
                  private-key: ${{ secrets.INFRA_GITHUB_APP_PRIVATE_KEY }}
                  owner: ${{ env.INFRA_REPO_OWNER }}
                  repositories: ${{ env.INFRA_REPO_NAME }}

            - name: Debug infra token
              run: |
                  curl -sS -H "Authorization: token ${{ steps.infra_token.outputs.token }}" \
                    https://api.github.com/repos/kodustech/kodus-infra | jq '{full_name, permissions}'

            - name: Checkout code
              uses: actions/checkout@v4.2.2

            - name: Configure AWS Credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4.1.0
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2.0.1

            - name: Mask ECR registry
              run: echo "::add-mask::${{ steps.login-ecr.outputs.registry }}"

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3.2.0
              with:
                  platforms: arm64

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3.10.0

            - name: Build, tag, and push (api/webhooks/worker)
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  API_TAGS: ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY_API }}:${{ env.IMAGE_TAG }}
                  WEBHOOKS_TAGS: ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY_WEBHOOKS }}:${{ env.IMAGE_TAG }}
                  WORKER_TAGS: ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY_WORKER }}:${{ env.IMAGE_TAG }}
              run: |
                  set -euo pipefail

                  docker buildx bake -f docker-bake.hcl \
                    --set base.args.RELEASE_VERSION=${{ env.IMAGE_TAG }} \
                    --set base.args.API_CLOUD_MODE=true \
                    --set base.cache-from=type=gha,scope=${{ env.BUILDX_CACHE_SCOPE }} \
                    --set base.cache-to=type=gha,scope=${{ env.BUILDX_CACHE_SCOPE }},mode=max \
                    --set *.platform=${{ env.BUILDX_PLATFORMS }} \
                    --push

            - name: Checkout infra repo
              uses: actions/checkout@v4.2.2
              with:
                  repository: ${{ env.INFRA_REPO }}
                  ref: ${{ env.INFRA_BASE_BRANCH }}
                  token: ${{ steps.infra_token.outputs.token }}
                  path: infra

            - name: Update tfvars (deploy to idle side)
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
              run: |
                  set -euo pipefail

                  FILE="infra/${{ env.INFRA_TFVARS_PATH }}"
                  API_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_API }}:${{ env.IMAGE_TAG }}"
                  WEBHOOKS_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WEBHOOKS }}:${{ env.IMAGE_TAG }}"
                  WORKER_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WORKER }}:${{ env.IMAGE_TAG }}"

                  ./scripts/gitops/update-tfvars-deploy.sh \
                    "$FILE" \
                    "$API_IMAGE" \
                    "$WEBHOOKS_IMAGE" \
                    "$WORKER_IMAGE"

                  echo "‚úÖ Updated $FILE"

            - name: Verify infra changes scope
              run: |
                  set -euo pipefail
                  cd infra
                  changed="$(git diff --name-only)"
                  if [ "$(echo "$changed" | wc -l | tr -d ' ')" -ne 1 ]; then
                    echo "Expected exactly 1 changed file in infra repo."
                    exit 1
                  fi
                  if [ "$changed" != "${{ env.INFRA_TFVARS_PATH }}" ]; then
                    echo "Unexpected changed file: $changed"
                    exit 1
                  fi

            - name: Create PR (Step 1 Deploy)
              id: create_pr
              uses: peter-evans/create-pull-request@v7
              with:
                  token: ${{ steps.infra_token.outputs.token }}
                  path: infra
                  branch: deploy/prod-${{ env.IMAGE_TAG }}
                  base: ${{ env.INFRA_BASE_BRANCH }}
                  title: "PROD Deploy (Step 1/3): New version ${{ env.IMAGE_TAG }}"
                  commit-message: "prod: deploy v${{ env.IMAGE_TAG }} to idle side (step 1/3)"
                  body: |
                      ## üìã Deployment Checklist
                      - [ ] Was the release file (`orchestrator.auto.tfvars.json`) updated with the correct image tag?
                      - [ ] (If promotion) Are the Target Groups for the destination environment Healthy?
                      - [ ] Is traffic being routed to the correct environment (Blue/Green)?

                      ## üõ† Atlantis Commands
                      > **Note:** Copy and paste the commands below as needed.

                      ### üöÄ Production
                      **App Services:**
                      ```bash
                      atlantis plan -p aws-prod-app-services-ecs-ec2
                      ```
                      ```bash
                      atlantis apply -p aws-prod-app-services-ecs-ec2
                      ```

                      **RabbitMQ:**
                      ```bash
                      atlantis plan -p aws-prod-rabbitmq-ec2
                      ```
                      ```bash
                      atlantis apply -p aws-prod-rabbitmq-ec2
                      ```

                      ---

                      ## üöÄ Blue/Green Deployment - Step 1: DEPLOY
                      **Version:** `${{ env.IMAGE_TAG }}`
                      **Target:** Idle environment (no traffic yet)

                      ### üìù Changes:
                      - ‚úÖ New images deployed to idle side
                      - ‚úÖ Cluster scaled to 8 instances
                      - ‚ö†Ô∏è **Weights unchanged** (no traffic shift yet)

                      ### ‚è≠Ô∏è Next Steps:
                      1. **Apply changes:**
                      ```bash
                      atlantis apply -p aws-prod-app-services-ecs-ec2
                      ```
                      2. **Validate health:**
                         - Check ECS console (tasks should be 2/2 or 3/3)
                         - Run: `./scripts/aws/debug/status-report.sh`
                         - Check logs: `./scripts/aws/debug/tail-logs.sh prod api`
                      3. **Shift Traffic:** Go to `kodus-infra` Actions ‚Üí Run "PROD - Shift Traffic" (Step 2)

                      ### üîô Rollback:
                      If deploy fails, just close this PR. No impact on production.

                      ---
                      *Automated deploy from kodus-ai release `${{ env.IMAGE_TAG }}`*
                      *Triggered by: @${{ github.actor }}*

            - name: Notify Discord (Deploy PR Created)
              if: success() && steps.create_pr.outputs.pull-request-number
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  if [ -n "$DISCORD_WEBHOOK" ]; then
                    curl -H "Content-Type: application/json" -X POST "$DISCORD_WEBHOOK" -d '{
                      "embeds": [{
                        "title": "üöÄ PROD: New Deploy Ready",
                        "description": "New version **v${{ env.IMAGE_TAG }}** deployed to idle environment",
                        "color": 5763719,
                        "fields": [
                          {"name": "Version", "value": "`${{ env.IMAGE_TAG }}`", "inline": true},
                          {"name": "Triggered by", "value": "@${{ github.actor }}", "inline": true},
                          {"name": "PR", "value": "[#${{ steps.create_pr.outputs.pull-request-number }}](${{ steps.create_pr.outputs.pull-request-url }})", "inline": false},
                          {"name": "Next Steps", "value": "1. Review and apply PR via Atlantis\n2. Validate health\n3. Run **Shift Traffic** workflow in kodus-infra", "inline": false}
                        ],
                        "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                      }]
                    }'
                  fi

            - name: Notify Discord (Deploy Failed)
              if: failure()
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
              run: |
                  if [ -n "$DISCORD_WEBHOOK" ]; then
                    curl -H "Content-Type: application/json" -X POST "$DISCORD_WEBHOOK" -d '{
                      "embeds": [{
                        "title": "‚ùå PROD: Deploy Failed",
                        "description": "Failed to deploy v${{ env.IMAGE_TAG }}",
                        "color": 15158332,
                        "fields": [
                          {"name": "Version", "value": "`${{ env.IMAGE_TAG }}`", "inline": true},
                          {"name": "Triggered by", "value": "@${{ github.actor }}", "inline": true},
                          {"name": "Action Required", "value": "Check workflow logs:\n[View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                        ],
                        "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                      }]
                    }'
                  fi
