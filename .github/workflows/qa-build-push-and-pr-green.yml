name: QA (GitOps) - Build/Push images + PR (deploy & promote)

on:
    push:
        branches: [main]
    workflow_dispatch:
        inputs:
            image_tag:
                description: "Image tag for ECR (default: github.sha)"
                required: false

concurrency:
    group: qa-gitops
    cancel-in-progress: true

permissions:
    contents: write

env:
    AWS_REGION: ${{ secrets.AWS_REGION }}
    IMAGE_TAG: ${{ github.event.inputs.image_tag || github.sha }}
    BUILDX_PLATFORMS: linux/arm64
    BUILDX_CACHE_SCOPE: kodus-ai-arm64

    # ECR repositories (required)
    ECR_REPOSITORY_API: ${{ vars.ECR_REPOSITORY_API }}
    ECR_REPOSITORY_WEBHOOKS: ${{ vars.ECR_REPOSITORY_WEBHOOKS }}
    ECR_REPOSITORY_WORKER: ${{ vars.ECR_REPOSITORY_WORKER }}

    # GitOps (required)
    INFRA_REPO: ${{ vars.INFRA_REPO }}
    INFRA_BASE_BRANCH: ${{ vars.INFRA_BASE_BRANCH }}
    INFRA_TFVARS_PATH: ${{ vars.INFRA_TFVARS_PATH }}

jobs:
    build_push_and_open_pr:
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        environment: qa
        permissions:
            contents: write
            id-token: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4.2.2

            - name: Validate required secrets
              run: |
                  set -euo pipefail
                  if [ -z "${{ vars.INFRA_GITHUB_APP_ID }}" ]; then echo "Missing variable: INFRA_GITHUB_APP_ID"; exit 1; fi
                  for v in ECR_REPOSITORY_API ECR_REPOSITORY_WEBHOOKS ECR_REPOSITORY_WORKER INFRA_REPO INFRA_BASE_BRANCH INFRA_TFVARS_PATH; do
                    if [ -z "${!v:-}" ]; then echo "Missing required variable: $v"; exit 1; fi
                  done
                  if [ -z "${{ secrets.INFRA_GITHUB_APP_PRIVATE_KEY }}" ]; then echo "Missing secret: INFRA_GITHUB_APP_PRIVATE_KEY"; exit 1; fi
                  if [ -z "${{ secrets.AWS_REGION }}" ]; then echo "Missing secret: AWS_REGION"; exit 1; fi
                  if [ -z "${{ secrets.AWS_ROLE_TO_ASSUME }}" ]; then echo "Missing secret: AWS_ROLE_TO_ASSUME (OIDC is required)"; exit 1; fi

            - name: Parse infra repo
              run: |
                  set -euo pipefail
                  repo="${{ env.INFRA_REPO }}"
                  if [[ "$repo" == */* ]]; then
                    owner="${repo%%/*}"
                    name="${repo#*/}"
                  else
                    owner="${{ github.repository_owner }}"
                    name="$repo"
                  fi
                  echo "INFRA_REPO_OWNER=$owner" >> "$GITHUB_ENV"
                  echo "INFRA_REPO_NAME=$name" >> "$GITHUB_ENV"

            - name: Get infra repo token (GitHub App)
              id: infra_token
              uses: actions/create-github-app-token@v1.11.0
              with:
                  app-id: ${{ vars.INFRA_GITHUB_APP_ID }}
                  private-key: ${{ secrets.INFRA_GITHUB_APP_PRIVATE_KEY }}
                  owner: ${{ env.INFRA_REPO_OWNER }}
                  repositories: ${{ env.INFRA_REPO_NAME }}

            - name: Configure AWS Credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4.1.0
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2.0.1

            - name: Mask ECR registry
              run: echo "::add-mask::${{ steps.login-ecr.outputs.registry }}"

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3.2.0
              with:
                  platforms: arm64

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3.10.0

            - name: Build, tag, and push (api/webhooks/worker)
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  API_TAGS: ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY_API }}:${{ env.IMAGE_TAG }}
                  WEBHOOKS_TAGS: ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY_WEBHOOKS }}:${{ env.IMAGE_TAG }}
                  WORKER_TAGS: ${{ steps.login-ecr.outputs.registry }}/${{ vars.ECR_REPOSITORY_WORKER }}:${{ env.IMAGE_TAG }}
              run: |
                  set -euo pipefail

                  docker buildx bake -f docker-bake.hcl \
                    --set base.args.RELEASE_VERSION=${{ env.IMAGE_TAG }} \
                    --set base.args.API_CLOUD_MODE=true \
                    --set base.cache-from=type=gha,scope=${{ env.BUILDX_CACHE_SCOPE }} \
                    --set base.cache-to=type=gha,scope=${{ env.BUILDX_CACHE_SCOPE }},mode=max \
                    --set *.platform=${{ env.BUILDX_PLATFORMS }} \
                    --push

                  docker buildx imagetools create \
                    -t "$ECR_REGISTRY/${{ env.ECR_REPOSITORY_API }}:qa-latest" \
                    "$API_TAGS"

                  docker buildx imagetools create \
                    -t "$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WEBHOOKS }}:qa-latest" \
                    "$WEBHOOKS_TAGS"

                  docker buildx imagetools create \
                    -t "$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WORKER }}:qa-latest" \
                    "$WORKER_TAGS"

            - name: Checkout infra repo
              uses: actions/checkout@v4.2.2
              with:
                  repository: ${{ env.INFRA_REPO }}
                  ref: ${{ env.INFRA_BASE_BRANCH }}
                  token: ${{ steps.infra_token.outputs.token }}
                  path: infra

            - name: Update tfvars (deploy to idle side)
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
              run: |
                  set -euo pipefail
                  FILE="infra/${{ env.INFRA_TFVARS_PATH }}"
                  API_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_API }}:${{ env.IMAGE_TAG }}"
                  WEBHOOKS_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WEBHOOKS }}:${{ env.IMAGE_TAG }}"
                  WORKER_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WORKER }}:${{ env.IMAGE_TAG }}"
                  DESIRED_COUNT=1

                  # Deploy to idle side (auto detects Blue/Green)
                  ./infra/scripts/gitops/update-tfvars-deploy.sh "$FILE" "$API_IMAGE" "$WEBHOOKS_IMAGE" "$WORKER_IMAGE" "$DESIRED_COUNT"

            - name: Update tfvars (shift traffic)
              run: |
                  set -euo pipefail
                  FILE="infra/${{ env.INFRA_TFVARS_PATH }}"

                  # Promotes to 100% traffic on the newly deployed side
                  node -e "
                    const fs = require('fs');
                    const file = process.argv[1];
                    const obj = JSON.parse(fs.readFileSync(file, 'utf8'));

                    // Detects which side was active BEFORE deploy
                    const greenWasActive = obj.api_green_weight === 100;

                    if (greenWasActive) {
                      // Green was active -> Blue received deploy -> Promote Blue
                      console.log('>>> Shifting traffic: GREEN (100%) -> BLUE (100%)');
                      obj.api_green_weight = 0;
                      obj.webhook_green_weight = 0;
                      if (obj.api_blue_weight !== undefined) obj.api_blue_weight = 100;
                    } else {
                      // Blue was active -> Green received deploy -> Promote Green
                      console.log('>>> Shifting traffic: BLUE (100%) -> GREEN (100%)');
                      obj.api_green_weight = 100;
                      obj.webhook_green_weight = 100;
                      if (obj.api_blue_weight !== undefined) obj.api_blue_weight = 0;
                    }

                    fs.writeFileSync(file, JSON.stringify(obj, null, 2) + '\n');
                    console.log('✅ Traffic shifted successfully');
                  " "$FILE"

            - name: Verify infra changes scope
              run: |
                  set -euo pipefail
                  cd infra
                  changed="$(git diff --name-only)"
                  if [ "$(echo "$changed" | wc -l | tr -d ' ')" -ne 1 ]; then
                    echo "Expected exactly 1 changed file in infra repo."; exit 1; fi
                  if [ "$changed" != "${{ env.INFRA_TFVARS_PATH }}" ]; then
                    echo "Unexpected changed file: $changed"; exit 1; fi

            - name: Create PR on infra (QA deploy & promote)
              uses: peter-evans/create-pull-request@v7
              with:
                  token: ${{ steps.infra_token.outputs.token }}
                  path: infra
                  branch: ci/qa-${{ env.IMAGE_TAG }}
                  base: ${{ env.INFRA_BASE_BRANCH }}
                  title: "QA: deploy & promote (${{ env.IMAGE_TAG }})"
                  body: |
                      **QA Environment: Deploy + Traffic Shift**

                      Deploys new images to idle side and promotes to 100% traffic.

                      - **Tag**: `${{ env.IMAGE_TAG }}`
                      - **Branch**: `${{ env.INFRA_BASE_BRANCH }}`

                      This PR will be auto-applied by Atlantis.
                  commit-message: "qa: deploy & promote ${{ env.IMAGE_TAG }}"
                  labels: auto-apply

            - name: Notify Discord (success)
              if: env.DISCORD_WEBHOOK
              uses: sarisia/actions-status-discord@v1.13.0
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
              with:
                  status: success
                  content: "✅ QA build + infra PR created\nTag: `${{ env.IMAGE_TAG }}`\nInfra branch: `${{ env.INFRA_BASE_BRANCH }}`"
                  username: "GitHub Actions (QA)"

            - name: Notify Discord (failure)
              if: failure() && env.DISCORD_WEBHOOK
              uses: sarisia/actions-status-discord@v1.13.0
              env:
                  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
              with:
                  status: failure
                  content: "❌ QA pipeline failed (build/infra PR)\nTag: `${{ env.IMAGE_TAG }}`\nInfra branch: `${{ env.INFRA_BASE_BRANCH }}`"
                  username: "GitHub Actions (QA)"
