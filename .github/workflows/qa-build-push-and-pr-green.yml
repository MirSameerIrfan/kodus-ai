name: QA (GitOps) - Build/Push images + PR (deploy)

on:
    push:
        branches: [main]
    workflow_dispatch:
        inputs:
            image_tag:
                description: "Image tag for ECR (default: github.sha)"
                required: false

concurrency:
    group: qa-gitops
    cancel-in-progress: true

permissions:
    contents: write

env:
    AWS_REGION: ${{ secrets.AWS_REGION }}
    IMAGE_TAG: ${{ github.event.inputs.image_tag || github.sha }}
    BUILDX_PLATFORMS: linux/arm64
    BUILDX_CACHE_SCOPE: kodus-ai-arm64

    # ECR repositories (required)
    ECR_REPOSITORY_API: ${{ vars.ECR_REPOSITORY_API }}
    ECR_REPOSITORY_WEBHOOKS: ${{ vars.ECR_REPOSITORY_WEBHOOKS }}
    ECR_REPOSITORY_WORKER: ${{ vars.ECR_REPOSITORY_WORKER }}

    # GitOps (required)
    INFRA_REPO: ${{ vars.INFRA_REPO }}
    INFRA_BASE_BRANCH: ${{ vars.INFRA_BASE_BRANCH }}
    INFRA_TFVARS_PATH: ${{ vars.INFRA_TFVARS_PATH }}

jobs:
    build_push_and_open_pr:
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        environment: qa
        permissions:
            contents: write
            id-token: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4.2.2

            # ... (Passos de validaÃ§Ã£o, login ECR, Build e Push continuam IGUAIS) ...
            # ... Copie os passos atÃ© o "Build, tag, and push" do arquivo original ...

            - name: Checkout infra repo
              uses: actions/checkout@v4.2.2
              with:
                  repository: ${{ env.INFRA_REPO }}
                  ref: ${{ env.INFRA_BASE_BRANCH }}
                  token: ${{ steps.infra_token.outputs.token }}
                  path: infra

            - name: Update tfvars (Deploy new images)
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
              run: |
                  set -euo pipefail
                  FILE="infra/${{ env.INFRA_TFVARS_PATH }}"
                  API_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_API }}:${{ env.IMAGE_TAG }}"
                  WEBHOOKS_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WEBHOOKS }}:${{ env.IMAGE_TAG }}"
                  WORKER_IMAGE="$ECR_REGISTRY/${{ env.ECR_REPOSITORY_WORKER }}:${{ env.IMAGE_TAG }}"

                  # Usa o script simplificado para atualizar apenas as imagens
                  ./infra/scripts/gitops/update-tfvars-deploy.sh "$FILE" "$API_IMAGE" "$WEBHOOKS_IMAGE" "$WORKER_IMAGE"

            # ðŸš¨ REMOVIDO: Step "Update tfvars (shift traffic & cleanup)"
            # Com ECS Native, nÃ£o fazemos shift manual nem cleanup manual no cÃ³digo.

            - name: Verify infra changes scope
              run: |
                  set -euo pipefail
                  cd infra
                  changed="$(git diff --name-only)"
                  if [ "$(echo "$changed" | wc -l | tr -d ' ')" -ne 1 ]; then
                    echo "Expected exactly 1 changed file in infra repo."; exit 1; fi
                  if [ "$changed" != "${{ env.INFRA_TFVARS_PATH }}" ]; then
                    echo "Unexpected changed file: $changed"; exit 1; fi

            - name: Create PR on infra (QA Deploy)
              uses: peter-evans/create-pull-request@v7
              with:
                  token: ${{ steps.infra_token.outputs.token }}
                  path: infra
                  branch: ci/qa-${{ env.IMAGE_TAG }}
                  base: ${{ env.INFRA_BASE_BRANCH }}
                  title: "QA: deploy (${{ env.IMAGE_TAG }})"
                  body: |
                      ## ðŸš€ QA Deployment (Native ECS Blue/Green)
                      Updating images to `${{ env.IMAGE_TAG }}`.

                      ## ðŸ›  Atlantis Commands
                      atlantis plan -p aws-qa-app-services-ecs-ec2
                      # ApÃ³s aprovaÃ§Ã£o e apply, o ECS gerencia o Blue/Green automaticamente.
